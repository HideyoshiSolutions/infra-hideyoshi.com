name: remote ssh command
on: [push]

env:
    TOKEN_SECRET: ${{ secrets.TOKEN_SECRET }}
    ACCESS_TOKEN_DURATION: ${{ secrets.ACCESS_TOKEN_DURATION }}
    REFRESH_TOKEN_DURATION: ${{ secrets.REFRESH_TOKEN_DURATION }}
    DEFAULT_USER_FULLNAME: ${{ secrets.DEFAULT_USER_FULLNAME }}
    DEFAULT_USER_EMAIL: ${{ secrets.DEFAULT_USER_EMAIL }}
    DEFAULT_USER_USERNAME: ${{ secrets.DEFAULT_USER_USERNAME }}
    DEFAULT_USER_PASSWORD: ${{ secrets.DEFAULT_USER_PASSWORD }}
    GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
    GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
    GOOGLE_REDIRECT_URL: ${{ secrets.GOOGLE_REDIRECT_URL }}
    OAUTH_GITHUB_CLIENT_ID: ${{ secrets.OAUTH_GITHUB_CLIENT_ID }}
    OAUTH_GITHUB_CLIENT_SECRET: ${{ secrets.OAUTH_GITHUB_CLIENT_SECRET }}
    OAUTH_GITHUB_REDIRECT_URL: ${{ secrets.OAUTH_GITHUB_REDIRECT_URL }}
    POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
    OSTGRES_PASSWORD: P{{ secrets.OSTGRES_PASSWORD }}
    POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
    REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}

jobs:
    build:
        name: Build
        runs-on: ubuntu-latest
        steps:
            - name: checkout
              uses: actions/checkout@v2

            - name: Inserts Prod Enviromental Variables
              run: |
                envsubst < $GITHUB_WORKSPACE/backend/backend-secret.template.yaml > $GITHUB_WORKSPACE/backend/backend-secret.yaml;
                envsubst < $GITHUB_WORKSPACE/postgres/postgres-secret.template.yaml > $GITHUB_WORKSPACE/postgres/postgres-secret.yaml;
                envsubst < $GITHUB_WORKSPACE/redis/redis-secret.template.yaml > $GITHUB_WORKSPACE/redis/redis-secret.yaml;

            - name: copy file via ssh
              uses: appleboy/scp-action@master
              with:
                host: ${{ secrets.HOST }}
                username: ${{ secrets.USERNAME }}
                key: ${{ secrets.SSH_KEY }}
                port: ${{ secrets.PORT }}
                source: "."
                target: "infra-hideyoshi.com"

